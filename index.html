<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Billing System</title>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    min-height: 100vh;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
}
.container {
    background: #fff;
    width: 95%;
    max-width: 980px;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}
h1 { text-align: center; margin-bottom: 15px; }
.top-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-weight: 600;
}
.customer-input {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-bottom: 15px;
}
.inputs {
    display: grid;
    grid-template-columns: 1fr 2fr 1fr 1fr auto;
    gap: 10px;
}
input {
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
}
button {
    padding: 10px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}
.add-btn { background: #4CAF50; color: white; }
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
th, td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: center;
}
th { background: #f4f4f4; }
.action-btn {
    padding: 6px 10px;
    margin: 0 3px;
    border-radius: 5px;
    font-size: 13px;
}
.edit { background: #2196F3; color: white; }
.delete { background: #f44336; color: white; }
.total {
    text-align: right;
    font-size: 18px;
    margin-top: 15px;
    font-weight: bold;
}
.actions {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
}
.download { background: #3f51b5; color: white; }
.print { background: #ff9800; color: white; }

/* MODAL */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;

    /* ‚úÖ allow scrolling */
    overflow-y: auto;
    padding: 20px;
}

.modal-content {
    background: #fff;
    padding: 20px;
    border-radius: 12px;

    /* ‚úÖ wider modal */
    width: 720px;
    max-width: 95vw;

    max-height: 85vh;
    overflow-y: auto;
}
/* FORCE modal to be wide */
.modal-content {
    width: 900px !important;
    max-width: 95vw !important;
    min-width: 900px !important;
}

.modal-content input {
    width: 100%;
    padding: 10px 12px;        /* equal padding left & right */
    margin-bottom: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;    /* force inside width */
}
.modal-content input[type="date"] {
    padding-right: 36px;   /* space for calendar icon */
}
.modal-actions {
    display: flex;
    justify-content: space-between;
}
/* Bigger, cleaner inputs for Add Past Invoice */
.big-input {
    padding: 12px 14px;
    font-size: 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    height: 44px;
}
/* üî• Invoice History Action Buttons */
.history-actions {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}

.history-actions .add-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    color: #fff;
    box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.history-actions .add-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 22px rgba(0,0,0,0.2);
}

/* Individual button colors */
.btn-add {
    background: linear-gradient(135deg, #00c853, #2e7d32);
}

.btn-backup {
    background: linear-gradient(135deg, #2979ff, #0d47a1);
}

.btn-restore {
    background: linear-gradient(135deg, #ff9100, #ef6c00);
}
/* üîç Search Bar Styling */
.history-search {
    width: 100%;
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid #ddd;
    font-size: 14px;
    outline: none;
    margin-bottom: 14px;
    background: #f9fbff;
    transition: border 0.2s ease, box-shadow 0.2s ease;
}

.history-search:focus {
    border-color: #2979ff;
    box-shadow: 0 0 0 3px rgba(41, 121, 255, 0.2);
    background: #fff;
}
/* üî• Universal Button Style */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 22px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 700;
    color: #fff;
    border: none;
    cursor: pointer;
    letter-spacing: 0.3px;

    box-shadow: 0 8px 18px rgba(0,0,0,0.18);
    transition:
        transform 0.2s ease,
        box-shadow 0.2s ease,
        filter 0.2s ease;
}

.btn:hover {
    transform: translateY(-3px) scale(1.03);
    box-shadow: 0 14px 30px rgba(0,0,0,0.25);
    filter: brightness(1.08);
}

.btn:active {
    transform: translateY(0) scale(0.97);
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}
/* ‚ûï Add Button */
.btn-add-main {
    background: linear-gradient(135deg, #4caf50, #2e7d32);
}

/* ‚¨áÔ∏è Download PDF */
.btn-download {
    background: linear-gradient(135deg, #3f51b5, #1a237e);
}

/* üìö Invoice History */
.btn-history {
    background: linear-gradient(135deg, #3949ab, #283593);
}

/* üñ®Ô∏è Print PDF */
.btn-print {
    background: linear-gradient(135deg, #ff9800, #ef6c00);
}
/* üßæ Invoice View / Delete Modal (Narrow & Clean) */
.invoice-view-modal {
    width: 420px;
    max-width: 90vw;
    padding: 22px 24px;
    border-radius: 14px;
}

/* Improve spacing inside */
.invoice-view-modal h3 {
    margin-top: 0;
    margin-bottom: 10px;
}

.invoice-view-modal p {
    margin: 6px 0;
    line-height: 1.5;
}

/* Buttons aligned nicely */
.invoice-view-modal .modal-actions {
    margin-top: 18px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

</style>
</head>

<body>
<div class="container">

<h1>üßæ Billing System</h1>

<div class="top-info">
    <div id="invoiceNo"></div>
    <div id="invoiceDate"></div>
</div>

<input type="text" id="customerName" class="customer-input" placeholder="Customer Name">

<div class="inputs">
    <input type="date" id="date">
    <input list="products" id="product" placeholder="Product name">
    <datalist id="products"></datalist>

    <!-- NEW -->
    <select id="plateType">
        <option value="full">Full Plate</option>
        <option value="half">Half Plate</option>
    </select>

    <input type="number" id="price" placeholder="Price">
    <input type="number" id="qty" placeholder="Qty" value="1">
    <button class="btn btn-add-main" onclick="addItem()">
    ‚ûï Add
   </button>

</div>


<table id="billTable">
<thead>
<tr>
    <th>Date</th>
    <th>Product</th>
    <th>Price</th>
    <th>Qty</th>
    <th>Amount</th>
    <th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
<div style="display:flex;justify-content:flex-end;gap:10px;margin-top:10px;">
    <label style="font-weight:600;">Deduction:</label>
    <input
        type="number"
        id="deduction"
        value="0"
        min="0"
        style="width:120px;padding:6px;border-radius:6px;border:1px solid #ccc;"
        oninput="updateTotal()"
    >
</div>

<div class="total" id="total">Total: ‚Çπ0</div>
<div class="total" id="finalTotal">Payable: ‚Çπ0</div>


<div class="actions">
    <button class="btn btn-download" onclick="downloadPDF()">
        ‚¨áÔ∏è Download PDF
    </button>

    <button class="btn btn-history" onclick="openHistory()">
        üìö Invoice History
    </button>

    <button class="btn btn-print" onclick="printPDF()">
        üñ®Ô∏è Print PDF
    </button>
</div>

</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal">
<div class="modal-content">
    <h3>Edit Item</h3>
    <input type="date" id="mDate">
    <input type="text" id="mProduct">
    <input type="number" id="mPrice">
    <input type="number" id="mQty">
    <div class="modal-actions">
        <button class="add-btn" onclick="saveEdit()">Save</button>
        <button class="delete" onclick="closeModal()">Cancel</button>
    </div>
</div>
</div>

<script>
/* DATE FORMATTER */
function formatDateToDDMMYYYY(dateInput) {
    const d = new Date(dateInput);
    const day = String(d.getDate()).padStart(2,"0");
    const month = String(d.getMonth()+1).padStart(2,"0");
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}

let total = 0;
let editRowRef = null;

/* INVOICE NUMBER */
const invoiceNumber =
    "INV-" +
    new Date().toISOString().slice(0,10).replace(/-/g,"") +
    "-" +
    Math.floor(1000 + Math.random()*9000);

invoiceNo.innerText = "Invoice No: " + invoiceNumber;
invoiceDate.innerText = "Date: " + formatDateToDDMMYYYY(new Date());

function updateTotal() {
    total = 0;

    document.querySelectorAll(".amount").forEach(a => {
        total += Number(a.innerText);
    });

    const deductionInput = document.getElementById("deduction");
    const deduction = Number(deductionInput.value) || 0;

    if (deduction > total) {
        showError("Deduction cannot be greater than total amount.");
        deductionInput.value = 0;
        return;
    }

    const payable = total - deduction;

    totalEl.innerText = `Total: ‚Çπ${total}`;
    document.getElementById("finalTotal").innerText = `Payable: ‚Çπ${payable}`;
}


function addItem() {
    if (!date.value || !product.value || !price.value || !qty.value) {
        showError("Please fill all fields before adding the item.");
        return;
    }

    const isSnack = noHalfPlateItems.includes(product.value);

    let plateLabel = "";
    if (!isSnack) {
        plateLabel = plateType.value === "half" ? " (Half)" : " (Full)";
    }

    const finalPrice = Number(price.value);
    const quantity = Number(qty.value);
    const amount = finalPrice * quantity;

    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${formatDateToDDMMYYYY(date.value)}</td>
        <td>${product.value}${plateLabel}</td>
        <td>${finalPrice}</td>
        <td>${quantity}</td>
        <td class="amount">${amount}</td>
        <td>
            <button class="action-btn edit" onclick="openEdit(this)">Edit</button>
            <button class="action-btn delete" onclick="deleteRow(this)">Delete</button>
        </td>
    `;

    billTable.querySelector("tbody").appendChild(row);
    updateTotal();

    // Reset
    product.value = "";
    price.value = "";
    qty.value = 1;
    plateType.value = "full";
    product.focus();
}



function deleteRow(btn) {
    btn.closest("tr").remove();
    updateTotal();
}

/* MODAL EDIT */
function openEdit(btn) {
    editRowRef = btn.closest("tr");
    mDate.value = editRowRef.cells[0].innerText.split("/").reverse().join("-");
    mProduct.value = editRowRef.cells[1].innerText;
    mPrice.value = editRowRef.cells[2].innerText;
    mQty.value = editRowRef.cells[3].innerText;
    editModal.style.display = "flex";
}

function saveEdit() {
    const amount = mPrice.value * mQty.value;
    editRowRef.cells[0].innerText = formatDateToDDMMYYYY(mDate.value);
    editRowRef.cells[1].innerText = mProduct.value;
    editRowRef.cells[2].innerText = mPrice.value;
    editRowRef.cells[3].innerText = mQty.value;
    editRowRef.cells[4].innerText = amount;
    updateTotal();
    closeModal();
}

function closeModal() {
    editModal.style.display = "none";
}

/* PDF */
function generatePDF(action) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // ===== DATE & TIME =====
  const now = new Date();
  const day = String(now.getDate()).padStart(2, "0");
  const month = String(now.getMonth() + 1).padStart(2, "0");
  const year = now.getFullYear();
  let hours = now.getHours();
  const minutes = String(now.getMinutes()).padStart(2, "0");
  const ampm = hours >= 12 ? "PM" : "AM";
  hours = hours % 12 || 12;
  const formattedDateTime = `${day}/${month}/${year} ${hours}:${minutes} ${ampm}`;

  // ===== DECORATIVE HEADER BAND =====
  doc.setFillColor(232, 245, 233); // very light green
  doc.rect(0, 0, 210, 28, "F");

  // ===== TITLE =====
  doc.setFontSize(20);
  doc.setTextColor(0, 0, 0);
  doc.text("HARE KRISHNA", 14, 18);

  // ===== INFO CARD =====
  doc.setFillColor(245, 247, 250);
  doc.roundedRect(12, 30, 186, 28, 4, 4, "F");

  doc.setFontSize(11);
  doc.text(`Invoice No: ${invoiceNumber}`, 16, 40);
  doc.text(`Customer Name: ${customerName.value || "-"}`, 16, 48);

  doc.setFontSize(10);
  doc.text(`Generated on: ${formattedDateTime}`, 16, 56);

  // ===== TABLE DATA =====
  const data = [];
  document.querySelectorAll("#billTable tbody tr").forEach(r => {
    data.push([
      r.cells[0].innerText,
      r.cells[1].innerText,
      r.cells[2].innerText,
      r.cells[3].innerText,
      r.cells[4].innerText
    ]);
  });

  const deduction = Number(document.getElementById("deduction").value) || 0;
  const payable = total - deduction;

  // ===== FOOTER ROWS (DYNAMIC) =====
  const footerRows = [];
  footerRows.push(["", "", "", "Total", total.toString()]);

  if (deduction > 0) {
    footerRows.push(["", "", "", "Deduction", deduction.toString()]);
    footerRows.push(["", "", "", "Payable", payable.toString()]);
  }

  // ===== TABLE =====
  doc.autoTable({
    startY: 64,

    head: [["Date", "Product", "Price", "Qty", "Amount"]],
    body: data,
    foot: footerRows,

    styles: {
      halign: "center",
      textColor: [0, 0, 0]
    },

    headStyles: {
      fillColor: [76, 175, 80], // green header
      textColor: [255, 255, 255],
      fontStyle: "bold"
    },

    alternateRowStyles: {
      fillColor: [248, 250, 248] // zebra striping
    },

    footStyles: {
      fillColor: [255, 255, 255],
      lineWidth: 0.5,
      lineColor: [200, 200, 200]
    },

    columnStyles: {
      4: {
        fontStyle: "bold",
        textColor: [56, 142, 60]
      }
    },

    didParseCell: function (data) {
      if (data.section === "foot") {
        const label = data.row.raw[3];

        // Only Total (deduction = 0)
        if (label === "Total" && deduction === 0) {
          data.cell.styles.textColor = [76, 175, 80];
          data.cell.styles.fontStyle = "bold";
          data.cell.styles.fontSize = 12;
        }

        // Total when deduction exists
        if (label === "Total" && deduction > 0) {
          data.cell.styles.textColor = [60, 60, 60];
          data.cell.styles.fontStyle = "bold";
        }

        // Deduction
        if (label === "Deduction") {
          data.cell.styles.textColor = [198, 40, 40];
          data.cell.styles.fontStyle = "bold";
        }

        // Payable
        if (label === "Payable") {
          data.cell.styles.textColor = [76, 175, 80];
          data.cell.styles.fontStyle = "bold";
        }
      }
    }
  });

  // ===== DIVIDER ABOVE FOOTER =====
  const finalY = doc.lastAutoTable.finalY + 2;
  doc.setDrawColor(200, 230, 201);
  doc.line(14, finalY, 196, finalY);

  // ===== FOOTER NOTE =====
doc.setFontSize(9);
doc.setTextColor(120, 120, 120);
doc.text(
  "This is a computer-generated invoice",
  105,
  285,
  { align: "center" }
);

  // ===== SAVE / PRINT =====
  action === "download"
    ? doc.save("invoice.pdf")
    : (doc.autoPrint(), window.open(doc.output("bloburl")));
}
function hasInvoiceData() {
    return document.querySelectorAll("#billTable tbody tr").length > 0;
}

function showError(message) {
    document.getElementById("errorMessage").innerText = message;
    document.getElementById("errorModal").style.display = "flex";
}

function closeErrorModal() {
    document.getElementById("errorModal").style.display = "none";
}

function downloadPDF() {
    if (!hasInvoiceData()) {
        showError("Please enter data to download the invoice.");
        return;
    }
    saveInvoiceToLocal();
    generatePDF("download");
}


function printPDF() {
    if (!hasInvoiceData()) {
        showError("Please enter data to print the invoice.");
        return;
    }
    saveInvoiceToLocal();
    generatePDF("print");
}

function saveInvoiceToLocal() {
    const items = [];
    document.querySelectorAll("#billTable tbody tr").forEach(r => {
        items.push({
            date: r.cells[0].innerText,
            product: r.cells[1].innerText,
            price: r.cells[2].innerText,
            qty: r.cells[3].innerText,
            amount: r.cells[4].innerText
        });
    });

    const invoice = {
        invoiceNo: invoiceNumber,
        customer: customerName.value,
        deduction: deduction.value,
        total,
        date: new Date().toISOString(),
        items
    };

    const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
    invoices.push(invoice);
    localStorage.setItem("invoices", JSON.stringify(invoices));
}
// PRODUCT MASTER pricing
const HALF_PLATE_FACTOR = 0.5; // 50% price
const productMaster = {
    "Veg Momo (8pieces)": 40,
    "Mathura cake": 10,
    "Biryani full": 100,
    "Vegetable Chop": 8,
    "Samosa": 7,
    "Beguni": 6,
    "Alu Chop": 6,
    "Chawanprash 250g": 150,
    "Fruit cake": 50,
    "Idli": 25,
    "Paneer Roll": 45,
    "Veg Chowmin(1 plate)": 40,
    "Paneer Chowmin (1plate)": 50,
    "Fried Rice(1plate)": 120,
    "Paneer Fried Rice(1plate)": 140,
    "Basanti Polau(1plate)": 140,
    "Chire vaja 250g": 50,
    "Dhone chutni 250g": 40,
    "Cream Muffins": 15,
    "Paneer Tikka": 35,
    "Patisapta (1 piece)": 20,
    "Motorsutir Kachuri": 7,
    "Jhalmuri 100g": 20,
    "Mix Veg (1plate)": 170,
    "Chilli Paneer (1plate)": 180,
};
const noHalfPlateItems = [
    "Veg Momo (8pieces)",
    "Mathura cake",
    "Vegetable Chop",
    "Samosa",
    "Beguni",
    "Alu Chop",
    "Chawanprash 250g",
    "Fruit cake",
    "Idli",
    "Paneer Roll",
    "Chire vaja 250g",
    "Dhone chutni 250g",
    "Cream Muffins",
    "Paneer Tikka",
    "Patisapta (1 piece)",
    "Motorsutir Kachuri",
    "Jhalmuri 100g",
];

// Populate datalist
const productList = document.getElementById("products");
for (let p in productMaster) {
    const option = document.createElement("option");
    option.value = p;
    productList.appendChild(option);
}

// Auto-fill price when product selected
product.addEventListener("change", updatePriceByPlate);
plateType.addEventListener("change", updatePriceByPlate);

function updatePriceByPlate() {
    const basePrice = productMaster[product.value];
    if (!basePrice) return;

    // üö´ Disable half plate for snacks
    if (noHalfPlateItems.includes(product.value)) {
        plateType.value = "full";
        plateType.disabled = true;
        price.value = basePrice;
    } else {
        plateType.disabled = false;

        if (plateType.value === "half") {
            price.value = Math.round(basePrice * HALF_PLATE_FACTOR);
        } else {
            price.value = basePrice;
        }
    }

    qty.focus();
}


function autoCalculateAmount() {
    if (!price.value || !qty.value) return;
    // Reserved for future live preview if needed
}

// Live update while typing
price.addEventListener("input", autoCalculateAmount);
qty.addEventListener("input", autoCalculateAmount);
qty.addEventListener("keydown", e => {
    if (e.key === "Enter") {
        addItem();
    }
});

const totalEl = document.getElementById("total");
function openHistory() {
    const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
    renderInvoices(invoices);
    historyModal.style.display = "flex";
}
function renderInvoices(invoices, search = "") {
    const list = document.getElementById("historyList");
    list.innerHTML = "";

    invoices.forEach((inv, i) => {
        if (search && !inv.invoiceNo.toLowerCase().includes(search)) return;

        const highlightedInvoice = highlight(inv.invoiceNo, search);

        const card = document.createElement("div");
        card.style.border = "1px solid #ddd";
        card.style.borderRadius = "10px";
        card.style.padding = "12px";
        card.style.marginBottom = "12px";

        card.innerHTML = `
            <b>üßæ Invoice No:</b> ${highlightedInvoice}<br>
            <b>üë§ Customer:</b> ${inv.customer || "-"}<br>
            <b>üìÖ Created:</b> ${formatDateTime12H(inv.date)}<br>
            <b>üí∞ Total:</b> ‚Çπ${inv.total}
            <div style="margin-top:8px;">
                <button class="action-btn edit" onclick="viewInvoice(${i})">View</button>
                <button class="action-btn delete" onclick="confirmDelete(${i})">Delete</button>
            </div>
        `;

        list.appendChild(card);
    });
}

function searchInvoices() {
    const search = document.getElementById("invoiceSearch").value.toLowerCase();
    const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
    renderInvoices(invoices, search);
}

function highlight(text, search) {
    if (!search) return text;
    const regex = new RegExp(`(${search})`, "gi");
    return text.replace(regex, `<mark style="background:#ffeb3b;">$1</mark>`);
}

function closeHistory() {
    historyModal.style.display = "none";
}

function viewInvoice(index) {
    const invoices = JSON.parse(localStorage.getItem("invoices"));
    const inv = invoices[index];

    const deduction = Number(inv.deduction) || 0;
    const payable = inv.total - deduction;

    let html = `
        <h3 style="margin-top:0;">üßæ Invoice Details</h3>

        <p><b>Invoice No:</b> ${inv.invoiceNo}</p>
        <p><b>Customer:</b> ${inv.customer || "-"}</p>
        <p><b>Created On:</b> ${formatDateTime12H(inv.date)}</p>

        <table style="width:100%;font-size:13px;border-collapse:collapse;margin-top:10px;">
            <tr style="background:#f4f4f4;">
                <th style="padding:6px;">Date</th>
                <th style="padding:6px;">Product</th>
                <th style="padding:6px;">Price</th>
                <th style="padding:6px;">Qty</th>
                <th style="padding:6px;">Amount</th>
            </tr>
    `;

    inv.items.forEach(it => {
        html += `
            <tr>
                <td style="padding:6px;text-align:center;">${it.date}</td>
                <td style="padding:6px;">${it.product}</td>
                <td style="padding:6px;text-align:center;">${it.price}</td>
                <td style="padding:6px;text-align:center;">${it.qty}</td>
                <td style="padding:6px;text-align:center;">${it.amount}</td>
            </tr>
        `;
    });

    html += `
        </table>

        <div style="text-align:right;margin-top:10px;">
            <p><b>Total:</b> ‚Çπ${inv.total}</p>
    `;

    if (deduction > 0) {
        html += `
            <p style="color:#c62828;"><b>Deduction:</b> ‚Çπ${deduction}</p>
            <p style="color:#2e7d32;font-size:16px;">
                <b>Payable:</b> ‚Çπ${payable}
            </p>
        `;
    }

    html += `</div>`;

    viewContent.innerHTML = html;

    viewActions.innerHTML = `
        <button class="add-btn" onclick="closeView()">Close</button>
    `;

    viewModal.style.display = "flex";
}



function closeView() {
    viewModal.style.display = "none";
}

function confirmDelete(index) {
    viewContent.innerHTML = `
        <h3>‚ö†Ô∏è Delete Invoice</h3>
        <p>Are you sure you want to delete this invoice?</p>
    `;

    viewActions.innerHTML = `
        <button class="delete" onclick="deleteInvoice(${index})">Yes</button>
        <button class="add-btn" onclick="closeView()">No</button>
    `;

    viewModal.style.display = "flex";
}

function deleteInvoice(index) {
    const invoices = JSON.parse(localStorage.getItem("invoices"));
    invoices.splice(index, 1);
    localStorage.setItem("invoices", JSON.stringify(invoices));

    closeView();
    openHistory();

    showToast("Invoice deleted successfully");
}

function formatDateTime12H(isoString) {
    const d = new Date(isoString);

    const day = String(d.getDate()).padStart(2, "0");
    const month = String(d.getMonth() + 1).padStart(2, "0");
    const year = d.getFullYear();

    let hours = d.getHours();
    const minutes = String(d.getMinutes()).padStart(2, "0");
    const ampm = hours >= 12 ? "PM" : "AM";

    hours = hours % 12 || 12;

    return `${day}/${month}/${year} ${hours}:${minutes} ${ampm}`;
}
function showToast(message) {
    const toast = document.getElementById("toast");
    toast.innerText = "‚úÖ " + message;

    toast.classList.add("show");

    setTimeout(() => {
        toast.classList.remove("show");
    }, 3000);
}
function openAddInvoiceModal() {
    document.getElementById("aiItems").innerHTML = "";
    addInvoiceItem();
    addInvoiceModal.style.display = "flex";
}

function closeAddInvoiceModal() {
    addInvoiceModal.style.display = "none";
}

function addInvoiceItem() {
    const div = document.createElement("div");
    div.style.display = "grid";
    div.style.gridTemplateColumns = "160px 320px 140px 100px 140px";
    div.style.gap = "10px";
    div.style.marginBottom = "10px";

    div.innerHTML = `
        <input type="date" class="big-input">

        <input list="products" placeholder="Product name" class="big-input">

        <input type="number" placeholder="Price" class="big-input no-spinner">

        <input type="number" placeholder="Qty" class="big-input no-spinner">

        <input type="number" placeholder="Amount" class="big-input" readonly>
    `;

    const inputs = div.querySelectorAll("input");

    const dateInput = inputs[0];
    const productInput = inputs[1];
    const priceInput = inputs[2];
    const qtyInput = inputs[3];
    const amountInput = inputs[4];

    // Auto-fill price from product master
    productInput.addEventListener("change", () => {
        if (productMaster[productInput.value]) {
            priceInput.value = productMaster[productInput.value];
            updateAmount();
        }
    });

    function updateAmount() {
        const price = Number(priceInput.value);
        const qty = Number(qtyInput.value);
        amountInput.value = price && qty ? price * qty : "";
    }

    priceInput.addEventListener("input", updateAmount);
    qtyInput.addEventListener("input", updateAmount);

    document.getElementById("aiItems").appendChild(div);
}



function saveManualInvoice() {
    const invoiceNo = aiInvoiceNo.value.trim();
    const customer = aiCustomer.value.trim();
    const dateValue = aiDate.value;

    if (!invoiceNo || !dateValue) {
        alert("Invoice No and Generated Date are required");
        return;
    }

    const items = [];
    let total = 0;

    document.querySelectorAll("#aiItems > div").forEach(row => {
        const inputs = row.querySelectorAll("input");

        const itemDate = inputs[0].value;
        const product = inputs[1].value;
        const price = Number(inputs[2].value);
        const qty = Number(inputs[3].value);
        const amount = Number(inputs[4].value);

        if (itemDate && product && qty && amount) {
            items.push({
                date: formatDateToDDMMYYYY(itemDate),
                product,
                price,
                qty,
                amount
            });
            total += amount;
        }
    });

    if (items.length === 0) {
        alert("Add at least one product");
        return;
    }

    const deduction = Number(aiDeduction.value) || 0;

    if (deduction > total) {
        alert("Deduction cannot be greater than total");
        return;
    }

    const invoice = {
        invoiceNo,
        customer,
        date: new Date(dateValue).toISOString(),
        items,
        total,
        deduction
    };

    const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
    invoices.push(invoice);
    localStorage.setItem("invoices", JSON.stringify(invoices));

    closeAddInvoiceModal();
    openHistory();
    showToast("Past invoice added successfully");
}
function backupInvoices() {
    const invoices = localStorage.getItem("invoices");

    if (!invoices) {
        alert("No invoices to backup");
        return;
    }

    const blob = new Blob([invoices], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "invoice-backup.json";
    a.click();

    URL.revokeObjectURL(url);
}

function restoreInvoices(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
        try {
            const data = JSON.parse(e.target.result);

            if (!Array.isArray(data)) {
                alert("Invalid backup file");
                return;
            }

            localStorage.setItem("invoices", JSON.stringify(data));
            openHistory();
            showToast("Invoices restored successfully");
        } catch {
            alert("Failed to restore file");
        }
    };

    reader.readAsText(file);
}


</script>
<!-- ERROR MODAL -->
<div class="modal" id="errorModal">
  <div class="modal-content">
    <h3 style="margin-top:0;color:#f44336;">‚ö†Ô∏è Error</h3>
    <p id="errorMessage" style="margin:10px 0;"></p>
    <div class="modal-actions" style="justify-content:flex-end;">
      <button class="delete" onclick="closeErrorModal()">OK</button>
    </div>
  </div>
</div>
<!-- INVOICE HISTORY MODAL -->
<div class="modal" id="historyModal">
  <div class="modal-content" style="width:420px;">
<h3>üìö Invoice History</h3>

<div class="history-actions">
    <button class="add-btn btn-add" onclick="openAddInvoiceModal()">
        ‚ûï Add Past Invoice
    </button>

    <button class="add-btn btn-backup" onclick="backupInvoices()">
        ‚¨áÔ∏è Backup Invoices
    </button>

    <button class="add-btn btn-restore"
        onclick="document.getElementById('restoreFile').click()">
        ‚¨ÜÔ∏è Restore Invoices
    </button>
</div>


<hr>
<input
  type="text"
  id="invoiceSearch"
  placeholder="üîç Search by Invoice Number"
  oninput="searchInvoices()"
  class="history-search"
/>


<div id="historyList"></div>

    <div class="modal-actions">
      <button class="delete" onclick="closeHistory()">Close</button>
    </div>
  </div>
</div>
<!-- ADD PAST INVOICE MODAL -->
<div class="modal" id="addInvoiceModal">
  <div class="modal-content" style="width:440px;max-height:80vh;overflow:auto;">
    <h3>‚ûï Add Past Invoice</h3>

    <input id="aiInvoiceNo" placeholder="Invoice No">
    <input id="aiCustomer" placeholder="Customer Name">
    <input type="datetime-local" id="aiDate">

    <hr>

    <h4>Products</h4>
    <div id="aiItems"></div>

    <button class="add-btn" onclick="addInvoiceItem()">‚ûï Add Product</button>

    <hr>

    <input
  type="number"
  id="aiDeduction"
  class="big-input no-spinner"
  placeholder="Deduction amount"
 >


    <div class="modal-actions">
      <button class="add-btn" onclick="saveManualInvoice()">Save</button>
      <button class="delete" onclick="closeAddInvoiceModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- VIEW / DELETE MODAL -->
<div class="modal" id="viewModal">
  <div class="modal-content invoice-view-modal">
    <div id="viewContent"></div>
    <div class="modal-actions" id="viewActions"></div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast">
    ‚úÖ Invoice deleted successfully
</div>
<input
  type="file"
  id="restoreFile"
  accept=".json"
  style="display:none"
  onchange="restoreInvoices(event)"
>

<style>
.toast {
    position: fixed;
    bottom: 20px;
    left: 20px;
    min-width: 260px;
    background: linear-gradient(135deg, #43cea2, #185a9d);
    color: #fff;
    padding: 14px 18px 14px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    opacity: 0;
    transform: translateX(-20px);
    pointer-events: none;
    transition: opacity 0.4s ease, transform 0.4s ease;
    z-index: 9999;
}

.toast::before {
    content: "";
    position: absolute;
    left: 0;
    top: 0;
    width: 5px;
    height: 100%;
    background: #00e676;
    border-radius: 8px 0 0 8px;
}

.toast.show {
    opacity: 1;
    transform: translateX(0);
}
</style>

</body>
</html>