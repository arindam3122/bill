<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Billing System</title>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    min-height: 100vh;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
}
.container {
    background: #fff;
    width: 95%;
    max-width: 980px;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}
h1 { text-align: center; margin-bottom: 15px; }
.top-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-weight: 600;
}
.customer-input {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-bottom: 15px;
}
.inputs {
    display: grid;
    grid-template-columns: 1fr 2fr 1fr 1fr auto;
    gap: 10px;
}
input {
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
}
button {
    padding: 10px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}
.add-btn { background: #4CAF50; color: white; }
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
th, td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: center;
}
th { background: #f4f4f4; }
.action-btn {
    padding: 6px 10px;
    margin: 0 3px;
    border-radius: 5px;
    font-size: 13px;
}
.edit { background: #2196F3; color: white; }
.delete { background: #f44336; color: white; }
.total {
    text-align: right;
    font-size: 18px;
    margin-top: 15px;
    font-weight: bold;
}
.actions {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
}
.download { background: #3f51b5; color: white; }
.print { background: #ff9800; color: white; }

/* MODAL */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
}
.modal-content {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    width: 320px;
}
.modal-content input {
    width: 100%;
    padding: 10px 12px;        /* equal padding left & right */
    margin-bottom: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;    /* force inside width */
}
.modal-content input[type="date"] {
    padding-right: 36px;   /* space for calendar icon */
}
.modal-actions {
    display: flex;
    justify-content: space-between;
}
</style>
</head>

<body>
<div class="container">

<h1>üßæ Billing System</h1>

<div class="top-info">
    <div id="invoiceNo"></div>
    <div id="invoiceDate"></div>
</div>

<input type="text" id="customerName" class="customer-input" placeholder="Customer Name">

<div class="inputs">
    <input type="date" id="date">
    <input type="text" id="product" placeholder="Product name">
    <input type="number" id="price" placeholder="Price">
    <input type="number" id="qty" placeholder="Qty" value="1">
    <button class="add-btn" onclick="addItem()">Add</button>
</div>

<table id="billTable">
<thead>
<tr>
    <th>Date</th>
    <th>Product</th>
    <th>Price</th>
    <th>Qty</th>
    <th>Amount</th>
    <th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
<div style="display:flex;justify-content:flex-end;gap:10px;margin-top:10px;">
    <label style="font-weight:600;">Deduction:</label>
    <input
        type="number"
        id="deduction"
        value="0"
        min="0"
        style="width:120px;padding:6px;border-radius:6px;border:1px solid #ccc;"
        oninput="updateTotal()"
    >
</div>

<div class="total" id="total">Total: ‚Çπ0</div>
<div class="total" id="finalTotal">Payable: ‚Çπ0</div>


<div class="actions">
    <button class="download" onclick="downloadPDF()">Download PDF</button>
    <button class="print" onclick="printPDF()">Print PDF</button>
</div>
</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal">
<div class="modal-content">
    <h3>Edit Item</h3>
    <input type="date" id="mDate">
    <input type="text" id="mProduct">
    <input type="number" id="mPrice">
    <input type="number" id="mQty">
    <div class="modal-actions">
        <button class="add-btn" onclick="saveEdit()">Save</button>
        <button class="delete" onclick="closeModal()">Cancel</button>
    </div>
</div>
</div>

<script>
/* DATE FORMATTER */
function formatDateToDDMMYYYY(dateInput) {
    const d = new Date(dateInput);
    const day = String(d.getDate()).padStart(2,"0");
    const month = String(d.getMonth()+1).padStart(2,"0");
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}

let total = 0;
let editRowRef = null;

/* INVOICE NUMBER */
const invoiceNumber =
    "INV-" +
    new Date().toISOString().slice(0,10).replace(/-/g,"") +
    "-" +
    Math.floor(1000 + Math.random()*9000);

invoiceNo.innerText = "Invoice No: " + invoiceNumber;
invoiceDate.innerText = "Date: " + formatDateToDDMMYYYY(new Date());

function updateTotal() {
    total = 0;

    document.querySelectorAll(".amount").forEach(a => {
        total += Number(a.innerText);
    });

    const deductionInput = document.getElementById("deduction");
    const deduction = Number(deductionInput.value) || 0;

    if (deduction > total) {
        showError("Deduction cannot be greater than total amount.");
        deductionInput.value = 0;
        return;
    }

    const payable = total - deduction;

    totalEl.innerText = `Total: ‚Çπ${total}`;
    document.getElementById("finalTotal").innerText = `Payable: ‚Çπ${payable}`;
}


function addItem() {
    if (!date.value || !product.value || !price.value || !qty.value) {
        showError("Please fill all fields before adding the item.");
        return;
    }

    const amount = price.value * qty.value;

    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${formatDateToDDMMYYYY(date.value)}</td>
        <td>${product.value}</td>
        <td>${price.value}</td>
        <td>${qty.value}</td>
        <td class="amount">${amount}</td>
        <td>
            <button class="action-btn edit" onclick="openEdit(this)">Edit</button>
            <button class="action-btn delete" onclick="deleteRow(this)">Delete</button>
        </td>
    `;

    billTable.querySelector("tbody").appendChild(row);
    updateTotal();

    product.value = "";
    price.value = "";
    qty.value = 1;
}

function deleteRow(btn) {
    btn.closest("tr").remove();
    updateTotal();
}

/* MODAL EDIT */
function openEdit(btn) {
    editRowRef = btn.closest("tr");
    mDate.value = editRowRef.cells[0].innerText.split("/").reverse().join("-");
    mProduct.value = editRowRef.cells[1].innerText;
    mPrice.value = editRowRef.cells[2].innerText;
    mQty.value = editRowRef.cells[3].innerText;
    editModal.style.display = "flex";
}

function saveEdit() {
    const amount = mPrice.value * mQty.value;
    editRowRef.cells[0].innerText = formatDateToDDMMYYYY(mDate.value);
    editRowRef.cells[1].innerText = mProduct.value;
    editRowRef.cells[2].innerText = mPrice.value;
    editRowRef.cells[3].innerText = mQty.value;
    editRowRef.cells[4].innerText = amount;
    updateTotal();
    closeModal();
}

function closeModal() {
    editModal.style.display = "none";
}

/* PDF */
function generatePDF(action) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // üìÖ DATE + ‚è∞ TIME (12-hour format)
    const now = new Date();

    const day = String(now.getDate()).padStart(2, "0");
    const month = String(now.getMonth() + 1).padStart(2, "0");
    const year = now.getFullYear();

    let hours = now.getHours();
    const minutes = String(now.getMinutes()).padStart(2, "0");
    const ampm = hours >= 12 ? "PM" : "AM";
    hours = hours % 12 || 12; // convert 0 to 12

    const formattedDateTime = `${day}/${month}/${year} ${hours}:${minutes} ${ampm}`;

    // üßæ HEADER
   doc.setFontSize(20);
   doc.text(" Hare Krishna ", 14, 15);


    doc.setFontSize(11);
    doc.text(`Invoice No: ${invoiceNumber}`, 14, 23);
    doc.text(`Customer Name: ${customerName.value || "-"}`, 14, 30);

    doc.setFontSize(10);
    doc.text(`Generated on: ${formattedDateTime}`, 14, 36);

    // üìä TABLE DATA
    const data = [];
    document.querySelectorAll("#billTable tbody tr").forEach(r => {
        data.push([
            r.cells[0].innerText,
            r.cells[1].innerText,
            r.cells[2].innerText,
            r.cells[3].innerText,
            r.cells[4].innerText
        ]);
    });
    const deduction = Number(document.getElementById("deduction").value) || 0;
    const payable = total - deduction;

    doc.autoTable({
        startY: 42,
        head: [["Date", "Product", "Price", "Qty", "Amount"]],
        body: data,

        foot: [
        ["", "", "", "Total", total.toString()],
        ["", "", "", "Deduction", deduction.toString()],
        ["", "", "", "Payable", payable.toString()]
      ],


        styles: {
            halign: "center",
            textColor: [0, 0, 0]
        },

        headStyles: {
            fillColor: [100, 126, 234],
            textColor: [255, 255, 255],
            fontStyle: "bold"
        },

        footStyles: {
            fillColor: [230, 236, 255],
            textColor: [0, 0, 0],
            fontStyle: "bold",
            lineWidth: 0.5,
            lineColor: [180, 180, 180]
        },

        columnStyles: {
            4: { fontStyle: "bold" }
        }
    });

    // ‚¨áÔ∏è DOWNLOAD / üñ®Ô∏è PRINT
    action === "download"
        ? doc.save("invoice.pdf")
        : (doc.autoPrint(), window.open(doc.output("bloburl")));
}
function hasInvoiceData() {
    return document.querySelectorAll("#billTable tbody tr").length > 0;
}

function showError(message) {
    document.getElementById("errorMessage").innerText = message;
    document.getElementById("errorModal").style.display = "flex";
}

function closeErrorModal() {
    document.getElementById("errorModal").style.display = "none";
}

function downloadPDF() {
    if (!hasInvoiceData()) {
        showError("Please enter data to download the invoice.");
        return;
    }
    generatePDF("download");
}

function printPDF() {
    if (!hasInvoiceData()) {
        showError("Please enter data to print the invoice.");
        return;
    }
    generatePDF("print");
}


const totalEl = document.getElementById("total");
</script>
<!-- ERROR MODAL -->
<div class="modal" id="errorModal">
  <div class="modal-content">
    <h3 style="margin-top:0;color:#f44336;">‚ö†Ô∏è Error</h3>
    <p id="errorMessage" style="margin:10px 0;"></p>
    <div class="modal-actions" style="justify-content:flex-end;">
      <button class="delete" onclick="closeErrorModal()">OK</button>
    </div>
  </div>
</div>

</body>
</html>